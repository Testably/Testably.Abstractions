using System.IO.Compression;

namespace Testably.Abstractions.Compression.Tests.ZipFile;

[FileSystemTests]
public partial class OpenTests
{
	[Fact]
	public async Task Open_CreateMode_ShouldInitializeEmptyArchive()
	{
		IZipArchive archive = FileSystem.ZipFile().Open("destination.zip", ZipArchiveMode.Create);

		await That(archive.Mode).Is(ZipArchiveMode.Create);
	}

	[Fact]
	public async Task Open_InvalidMode_ShouldThrowArgumentOutOfRangeException()
	{
		ZipArchiveMode invalidMode = (ZipArchiveMode)(-1);

		void Act()
		{
			FileSystem.ZipFile().Open("destination.zip", invalidMode);
		}

		await That(Act).Throws<ArgumentOutOfRangeException>()
			.WithParamName("mode");
	}

	[Theory]
	[InlineData(ZipArchiveMode.Read)]
	[InlineData(ZipArchiveMode.Update)]
	public async Task Open_ShouldOpenExistingArchive(ZipArchiveMode mode)
	{
		FileSystem.Initialize()
			.WithSubdirectory("foo");
		FileSystem.File.WriteAllText("foo/foo.txt", "FooFooFoo");
		FileSystem.ZipFile()
			.CreateFromDirectory("foo", "destination.zip", CompressionLevel.NoCompression,
				false);

		IZipArchive archive = FileSystem.ZipFile().Open("destination.zip", mode);

		await That(archive.Mode).Is(mode);
		await That(archive.Entries).Has().Exactly(1).Items();
	}

	[Fact]
	public async Task OpenRead_ShouldOpenExistingArchiveInReadMode()
	{
		FileSystem.Initialize()
			.WithSubdirectory("foo");
		FileSystem.File.WriteAllText("foo/foo.txt", "FooFooFoo");
		FileSystem.ZipFile()
			.CreateFromDirectory("foo", "destination.zip", CompressionLevel.NoCompression,
				false);

		IZipArchive archive = FileSystem.ZipFile().OpenRead("destination.zip");

		await That(archive.Mode).Is(ZipArchiveMode.Read);
		await That(archive.Entries).Has().Exactly(1).Items();
	}
}
