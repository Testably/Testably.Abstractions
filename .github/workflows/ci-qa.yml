name: CI-Analysis

on:
  workflow_run:
    workflows: [CI]
    types: [completed]

jobs:
  analyze:
    name: Static code analysis
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Download code coverage files (MacOS)
        uses: actions/download-artifact@v3
        with:
          name: Code coverage (MacOS)
          path: Coverage/MacOS
      - name: Download code coverage files (Ubuntu)
        uses: actions/download-artifact@v3
        with:
          name: Code coverage (Ubuntu)
          path: Coverage/Ubuntu
      - name: Download code coverage files (Windows)
        uses: actions/download-artifact@v3
        with:
          name: Code coverage (Windows)
          path: Coverage/Windows
      - name: SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.scm.revision=${{ github.event.workflow_run.head_sha }}
            -Dsonar.pullrequest.key=${{ github.event.workflow_run.pull_requests[0].number }}
            -Dsonar.pullrequest.branch=${{ github.event.workflow_run.pull_requests[0].head.ref }}
            -Dsonar.pullrequest.base=${{ github.event.workflow_run.pull_requests[0].base.ref }}
     
  comment:
    name: Add comments to PR
    runs-on: ubuntu-latest
    steps:
      - name: Add Stryker comment to pull request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          prNumber="${{ github.event.number }}"
          commentsUrl="https://api.github.com/repos/Testably/Testably.Abstractions/issues/$prNumber/comments"
          dashboardLink="uploaded report from the stryker build"
          echo "Search for comment in PR#$prNumber containing $dashboardLink..."
          result=$(curl -X GET $commentsUrl \
            -H "Content-Type: application/json" \
            -H "Authorization: token $GITHUB_TOKEN")
          if [[ $result != *"$dashboardLink"* ]]
          then
            body="{\"body\":\"Please check the uploaded report from the stryker build step."
            curl -X POST $commentsUrl \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: token $GITHUB_TOKEN" \
          	  -d "$body"
          fi