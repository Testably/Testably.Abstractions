name: "CI"

on:
  workflow_dispatch: 
  pull_request:
    branches: [main]
    
jobs:
  stryker:
    name: Analyze quality of unit test coverage with .NET Stryker
    runs-on: windows-latest
    timeout-minutes: 300
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Install .NET Stryker
        shell: bash
        run: |
          dotnet tool install dotnet-stryker --tool-path ./tools
      - name: Analyze Testably.Abstractions
        env:
          STRYKER_DASHBOARD_API_KEY: ${{ secrets.STRYKER_DASHBOARD_API_KEY }}
        shell: bash
        run: |
          ./tools/dotnet-stryker -f .github/stryker/Stryker.Config.json -v "${GITHUB_HEAD_REF}" -r "Dashboard" -r "cleartext" --since:main
      - name: Analyze Testably.Abstractions.AccessControl
        env:
          STRYKER_DASHBOARD_API_KEY: ${{ secrets.STRYKER_DASHBOARD_API_KEY }}
        shell: bash
        run: |
          ./tools/dotnet-stryker -f .github/stryker/Stryker.Config.AccessControl.json -v "${GITHUB_HEAD_REF}" -r "Dashboard" -r "cleartext" --since:main
      - name: Analyze Testably.Abstractions.Compression
        env:
          STRYKER_DASHBOARD_API_KEY: ${{ secrets.STRYKER_DASHBOARD_API_KEY }}
        shell: bash
        run: |
          ./tools/dotnet-stryker -f .github/stryker/Stryker.Config.Compression.json -v "${GITHUB_HEAD_REF}" -r "Dashboard" -r "cleartext" --since:main
      - name: Analyze Testably.Abstractions.Testing
        env:
          STRYKER_DASHBOARD_API_KEY: ${{ secrets.STRYKER_DASHBOARD_API_KEY }}
        shell: bash
        run: |
          ./tools/dotnet-stryker -f .github/stryker/Stryker.Config.Testing.json -v "${GITHUB_HEAD_REF}" -r "Dashboard" -r "cleartext" --since:main
          
  test-examples:
    name: Test (Examples)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Setup .NET
        uses: actions/setup-dotnet@v2
        with:
          dotnet-version: |
            6.0.x
      - name: Build solution
        run: dotnet build /p:NetCoreOnly=True
      - name: Build example solution
        run: dotnet build Examples /p:UseFileReferenceToTestablyLibraries=True
      - name: Run example tests
        run: dotnet test Examples --no-build
